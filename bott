# index.py

import json
import random
import telebot
from telebot import types
import boto3
import io # –î–æ–±–∞–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–æ–∫–∞–º–∏ –ø–∞–º—è—Ç–∏

from config import TG_BOT_TOKEN, YC_KEY_ID, YC_SECRET_KEY, BUCKET_NAME, ENDPOINT_URL

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞ S3
s3_client = boto3.client(
    's3',
    endpoint_url=ENDPOINT_URL,
    aws_access_key_id=YC_KEY_ID,
    aws_secret_access_key=YC_SECRET_KEY
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
bot = telebot.TeleBot(TG_BOT_TOKEN, parse_mode='Markdown')

# --- –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø (RU) ---
MESSAGES = {
    'ru': {
        'welcome': "üò∏–ü—Ä–∏–≤–µ—Ç, {name}! –Ø ‚Äî –ø—É—à–∏—Å—Ç—ã–π –ö–æ—Ç–æ–ë–æ—Ç.\n–û—Ç–ø—Ä–∞–≤–ª—è—é —Å–ª—É—á–∞–π–Ω—ã—Ö, –º–∏–ª—ã—Ö –∫–æ—Ç–æ–≤ –∏ –∫–æ—Ç–∏–∫–æ–≤!\n\n\n–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –∏ —Å–¥–µ–ª–∞–π –≤—ã–±–æ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é –ø–æ—Ä—Ü–∏—é –ø—É—à–∏—Å—Ç–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—èü´∂",
        'choose_category': "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        'realistic_btn': "–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∫–æ—Ç–∏–∫ üê±",
        'cartoon_btn': "–ú—É–ª—å—Ç—è—à–Ω—ã–π –∫–æ—Ç–∏–∫ üé®",
        'loading': "–ó–∞–≥—Ä—É–∂–∞—é –∫–∞—Ä—Ç–∏–Ω–∫—É... –∂–¥–∏—Ç–µ –ø—É—à–∏—Å—Ç–æ–µ —á—É–¥–æ ‚è≥",
        'no_pics': "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ —ç—Ç–æ–π –ø–∞–ø–∫–µ (–±–∞–∫–µ—Ç–µ) –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω–æ–∫ üòø"
    },
}

def get_messages(user_lang='ru'):
    return MESSAGES.get(user_lang, MESSAGES['ru'])

# --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ß–¢–ï–ù–ò–Ø –ò–ó S3 ---
def get_random_image_from_s3_stream(prefix_folder):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤–∏–¥–µ –ø–æ—Ç–æ–∫–∞ –±–∞–π—Ç–æ–≤ –∏–∑ S3 –±–∞–∫–µ—Ç–∞."""
    
    try:
        objects = s3_client.list_objects_v2(Bucket=BUCKET_NAME, Prefix=prefix_folder)
        
        if 'Contents' in objects:
            all_files = [obj['Key'] for obj in objects['Contents'] if obj['Key'] != prefix_folder and obj['Key'].lower().endswith(('.png', '.jpg', '.jpeg'))]
            
            # !!! –ù–û–í–ê–Ø –°–¢–†–û–ö–ê –î–õ–Ø –û–¢–õ–ê–î–ö–ò !!!
            print(f"DEBUG: Found files in list: {all_files}")
            
            if all_files:
                random_file_key = random.choice(all_files)
                print(f"DEBUG: Selected file key: {random_file_key}")
                
                # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å (–∫–∞–∫ –ø–æ—Ç–æ–∫ –±–∞–π—Ç–æ–≤)
                s3_object = s3_client.get_object(Bucket=BUCKET_NAME, Key=random_file_key)
                image_bytes = s3_object['Body'].read()
                return image_bytes
    except Exception as e:
        print(f"ERROR S3 access: {e}")
        return None
    return None

# --- (–û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ keyboard, send_welcome, callback_handler_cloud, handler –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
# --- –ö–ù–û–ü–ö–ò ---
def get_keyboard(lang_code='ru'):
    msgs = get_messages(lang_code)
    keyboard = types.InlineKeyboardMarkup()
    btn_realistic = types.InlineKeyboardButton(text=msgs['realistic_btn'], callback_data="get_realistic")
    btn_cartoon = types.InlineKeyboardButton(text=msgs['cartoon_btn'], callback_data="get_cartoon")
    keyboard.add(btn_realistic, btn_cartoon)
    return keyboard

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ handler) ---

@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    msgs = get_messages('ru')
    user_name = message.from_user.first_name or "–¥—Ä—É–≥"
    welcome_text = msgs['welcome'].format(name=user_name) 
    bot.reply_to(
        message,
        welcome_text,
        reply_markup=get_keyboard('ru')
    )

@bot.callback_query_handler(func=lambda call: True)
def callback_handler_cloud(call):
    msgs = get_messages('ru')
    bot.send_chat_action(call.message.chat.id, 'upload_photo')

    if call.data == "get_realistic":
        folder_prefix = 'realistic/'
    elif call.data == "get_cartoon":
        folder_prefix = 'cartoon/'
    else:
        return

    # –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∫–∞–∫ –±–∞–π—Ç—ã, –∞ –Ω–µ URL
    image_bytes = get_random_image_from_s3_stream(folder_prefix)

    if not image_bytes:
        bot.send_message(call.message.chat.id, msgs['no_pics'])
        return
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram
        bot.send_photo(
            chat_id=call.message.chat.id,
            photo=io.BytesIO(image_bytes), # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ç–æ–∫ –±–∞–π—Ç–æ–≤
            reply_markup=get_keyboard('ru') 
        )
    except Exception as e:
        print(f"ERROR sending photo to Telegram: {e}")
        bot.send_message(call.message.chat.id, f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ Telegram'–æ–º. –û—à–∏–±–∫–∞: {e}")


# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø YANDEX CLOUD FUNCTIONS (Entry point) ---

def handler(event, context):
    if 'body' not in event:
        return {'statusCode': 400, 'body': 'Bad Request'}
    
    try:
        update = telebot.types.Update.de_json(event['body'])
        bot.process_new_updates([update])
        return {
            'statusCode': 200,
            'body': 'OK'
        }
    except Exception as e:
        print(f"Error processing update: {e}")
        return {
            'statusCode': 500,
            'body': 'Internal Server Error'
        }
